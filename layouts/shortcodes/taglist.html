{{ $currPermalink := .Page.RelPermalink }}
{{ $tag := $.Params.tag }}
{{ $limit := int ($.Params.limit) }}
{{ $customTitle := .Get "title" | default "Related Content" }}
{{ $maxColumns := 4 }} <!-- Set the maximum number of columns here -->

{{ if (eq $limit -1) }}
  {{ $limit = len site.RegularPages }}
{{ end }}

{{ $categoryTitles := dict
  "SCALETutorials" "SCALE Tutorials"
  "SCALEUIReference" "SCALE UI Reference"
  "SCALECLIReference" "SCALE CLI Reference"
  "SCALE/GettingStarted" "Getting Started with SCALE"
  "CORE/GettingStarted" "Getting Started with CORE"
  "CORETutorials" "CORE Tutorials"
  "UIReference" "CORE UI Reference"
  "TrueCommand" "TrueCommand"
  "References" "General Reference"
  "Contributing" "Contributing"
  "Solutions" "Solutions"
}}

{{ $volCategories := dict
  "SCALE" "SCALE/GettingStarted,SCALETutorials,SCALEUIReference,SCALECLIReference,References,Solutions"
  "CORE" "CORE/GettingStarted,CORETutorials,UIReference,References,Solutions"
  "TrueCommand" "TrueCommand,SCALETutorials,CORETutorials,References,Solutions"
  "References" "References"
  "Contributing" "Contributing"
  "Solutions" "Solutions,SCALETutorials,CORETutorials,References"
}}

{{ $vol := .Get "vol" }} <!-- Get the "vol" parameter value -->
{{ $categories := index $volCategories $vol | default "" }}

{{ $firstCategory := index (split $categories ",") 0 }}
{{ $relatedCategories := slice }}
{{ $columnCounter := 1 }} <!-- Initialize the column counter -->
{{ $contentFound := false }} <!-- Initialize contentFound flag -->

<style>
  .taglist-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px; <!-- Adjust the gap as needed -->
  }

  .taglist-column {
    flex: 1;
    max-width: calc(25% - 20px); <!-- Set the desired column width with margin -->
    margin-right: 20px; <!-- Set the desired space between columns -->
  }

  .taglist-column:last-child {
    margin-right: 0; <!-- Remove margin from the last column -->
  }

  h2 {
    margin-top: 0;
  }

  hr {
    margin-top: 20px;
  }

  h3 {
    margin-top: 0;
  }

  /* Media query for small screens */
  @media screen and (max-width: 800px) {
    .taglist-container {
      flex-direction: column;
    }

    .taglist-column {
      max-width: 100%;
      margin-right: 0;
    }
  }
</style>

<hr>
<br>
<h2 class="taglist-title">{{ $customTitle }}</h2>

<div class="taglist-container">
  {{ range $category := (split $categories ",") }}
    {{ if ne $category "" }}
    {{ $categoryTitle := index $categoryTitles $category | default $category }}

      {{ $relatedPages := slice }}
      {{ range sort site.RegularPages "Params.weight" "asc" }}
        {{ $frontMatter := .Params }}
        {{ $pageTags := $frontMatter.tags }}
        {{ $pageCategory := $frontMatter.book }}
        {{ if and (not (eq .RelPermalink $currPermalink)) (or (eq $category "") (eq $pageCategory $category)) (in $pageTags $tag) }}
          {{ $relatedPages = $relatedPages | append . }}
          {{ $contentFound = true }} <!-- Set contentFound to true if content is found -->
        {{ end }}
      {{ end }}

      {{ if len $relatedPages }}
        {{ if le $columnCounter $maxColumns }}
          <div class="taglist-column">
            <h3>{{ $categoryTitle }}</h3>
            <ul>
              {{ range first $limit $relatedPages }}
                <li>
                  <a href="{{ .Permalink }}">{{ .Title }}</a>
                </li>
              {{ end }}
            </ul>
          </div>
          {{ $columnCounter = add $columnCounter 1 }}
        {{ end }}
      {{ end }}

      {{ $relatedCategories = $relatedCategories | append $category }}
    {{ end }}
  {{ end }}
  {{ if not $contentFound }}
    <!-- Render "No related content found" if content is not found in any category -->
    <div class="taglist-column">
      <p>No related content found</p>
    </div>
  {{ end }}
</div>
