<!-- Get src param from shortcode -->
{{ $src := $.Get "src"}}
{{ $image := .Page.Resources.GetMatch (.Get "src") }}
{{ $file := path.Join (path.Dir .Page.File.Path) $image }}
{{ $stat := os.Stat $file }}

<!-- Get alt param from shortcode -->
{{ $alt := $.Get "alt"}}

<!-- Get id param from shortcode -->
{{ $id := $.Get "id" }}

{{- $figureCounter := .Page.Scratch.Get "figureCounter" | default 0 }}
{{- $.Page.Scratch.Set "figureCounter" (add $figureCounter 1) }}

{{- with .Get "src" }}
  {{- $src := . }}
  {{- $image := resources.GetMatch . }}
  {{- if $image }}
    {{- $alt = $image.Title }}
  {{- end }}

  <div style="text-align:center;">
    <a href="{{ printf "%s" $src | absURL }}" target="_blank">
      <figure class="trueimg" id="{{ printf "figure-%d" $figureCounter }}"> <!-- Use $figureCounter for the ID -->
        <img src="{{ printf "%s" $src | absURL }}" title="{{ printf "%s" $alt }}" alt="{{ printf "%s" $alt }}" loading="lazy" decoding="async">
        <figcaption>
          <a href="#" onclick="return false" style="font-weight:bold;text-align:center;">
            <span id="fig-{{ $figureCounter }}" style="display: none;">{{ printf "Figure %d:%s" $figureCounter $id }}</span>
          </a>
        </figcaption>        
      </figure>
    </a>
  </div>
{{- else }}
  {{- errorf "missing value for param 'name': %s" .Position }}
{{- end }}

<script>
  // Update the caption with the correct figure number and text
  document.addEventListener("DOMContentLoaded", function () {
    var figureCounter = {{ $figureCounter }};
    var caption = document.getElementById("fig-" + figureCounter);
    if (caption) {
      var figCaption = caption.innerText;
      var figLink = document.querySelector("figcaption a");
      if (figLink) {
        figLink.innerHTML = figCaption;
      }
    }
  });
</script>
