{{ $currPermalink := .Page.RelPermalink }}
{{ $tags := .Params.tags }}
{{ $maxColumns := 4 }}

{{ $bookTitle := dict
  "SCALETutorials" "SCALE Tutorials"
  "SCALEUIReference" "SCALE UI Reference"
  "SCALECLIReference" "SCALE CLI Reference"
  "SCALE/GettingStarted" "Getting Started with SCALE"
  "CORE/GettingStarted" "Getting Started with CORE"
  "CORETutorials" "CORE Tutorials"
  "UIReference" "CORE UI Reference"
  "TrueCommand" "TrueCommand"
  "References" "General Reference"
  "Contributing" "Contributing"
  "Solutions" "Solutions"
}}

{{ $volume := dict
  "SCALETutorials" "SCALE"
  "SCALEUIReference" "SCALE"
  "SCALECLIReference" "SCALE"
  "SCALE/GettingStarted" "SCALE"
  "CORE/GettingStarted" "CORE"
  "CORETutorials" "CORE"
  "UIReference" "CORE"
  "TrueCommand" "TrueCommand"
  "References" "References"
  "Contributing" "Contributing"
  "Solutions" "Solutions"
}}

{{ $volBooks := dict
  "SCALE" "SCALE/GettingStarted,SCALETutorials,SCALEUIReference,SCALECLIReference,References,Solutions"
  "CORE" "CORE/GettingStarted,CORETutorials,UIReference,References,Solutions"
  "TrueCommand" "TrueCommand,SCALETutorials,CORETutorials,References,Solutions"
  "References" "References,SCALETutorials,CORETutorials"
  "Contributing" "Contributing"
  "Solutions" "Solutions,SCALETutorials,TrueCommand,CORETutorials,References"
}}

{{ $relatedCategories := slice }}
{{ $columnCounter := 1 }}
{{ $contentFound := false }}

<style>
  .taglist-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
  }

  .taglist-column {
    flex: 1;
    max-width: calc(25% - 20px);
    margin-right: 20px;
  }

  .taglist-column:last-child {
    margin-right: 0;
  }

  h2 {
    margin-top: 0;
  }

  hr {
    margin-top: 20px;
  }

  h3 {
    margin-top: 0;
  }

  @media screen and (max-width: 800px) {
    .taglist-container {
      flex-direction: column;
    }

    .taglist-column {
      max-width: 100%;
      margin-right: 0;
    }
  }
</style>

<hr>
<br>
<h2 class="taglist-title">Related Content</h2>

<div class="taglist-container">
  {{ range $book, $books := $volBooks }}
    {{ $categoryTitle := index $bookTitle $book }}
    {{ $relatedPages := slice }}
    {{ range sort site.RegularPages "Params.weight" "asc" }}
      {{ $frontMatter := .Params }}
      {{ $pageTags := $frontMatter.tags }}
      {{ $pageCategory := $frontMatter.book }}
      {{ $matchCategory := eq $book $pageCategory }}
      {{ $matchTags := intersect $tags $pageTags }}

      {{ if and (not (eq .RelPermalink $currPermalink)) (or $matchCategory (len $matchTags)) }}
        {{ $relatedPages = $relatedPages | append . }}
        {{ $contentFound = true }}
      {{ end }}
    {{ end }}

    {{ if len $relatedPages }}
      {{ if le $columnCounter $maxColumns }}
        <div class="taglist-column">
          <h3>{{ $categoryTitle }}</h3>
          <ul>
            {{ range first 5 $relatedPages }}
              <li>
                <a href="{{ .Permalink }}">{{ .Title }}</a>
              </li>
            {{ end }}
          </ul>
        </div>
        {{ $columnCounter = add $columnCounter 1 }}
      {{ end }}
    {{ end }}

    {{ $relatedCategories = $relatedCategories | append $book }}
  {{ end }}
</div>

{{ if not $contentFound }}
  <div class="taglist-column">
    <p>No related content found</p>
  </div>
{{ end }}